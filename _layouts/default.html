<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: 'en' }}">

  {%- include head.html -%}

  <body>

    {%- include header.html -%}

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <!-- New chord controls container -->
        <div id="chord-controls">
          <button id="chord-toggle-button">Show Chords</button>
        </div>
        
        <!-- The Jekyll content is now wrapped in a div for JavaScript access -->
        <div id="song-content">
          {{ content }}
        </div>
      </div>
    </main>

    {%- comment -%}
    {%- include footer.html -%}
    {%- include sub-footer.html -%}
    {%- endcomment -%}

    <!-- New JavaScript to process chords and handle the toggle -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const songContent = document.getElementById('song-content');
        const chordToggleButton = document.getElementById('chord-toggle-button');
        const body = document.body;
        
        // CSS to control the visual layout of the chords and lyrics.
        const style = document.createElement('style');
        style.textContent = `
          .chord-line, .lyric-line {
            display: block;
            white-space: pre;
            line-height: 1.2;
          }
          .chord {
            color: #d12a2a;
            font-weight: bold;
            display: inline-block;
            min-width: 1em;
            text-align: center;
          }
          .lyric-char {
            display: inline-block;
            min-width: 1ch;
          }
          body:not(.show-chords) .chord-line {
            display: none;
          }
          body.show-chords .chord-line {
            display: block;
          }
          body.show-chords .lyric-line {
            margin-bottom: 0.5em;
          }
        `;
        document.head.appendChild(style);

        // Regular expression to find text with chords in square brackets
        const chordRegex = /\[([^\\]]+)\]/g;
        const hasChordsOnPage = chordRegex.test(songContent.innerHTML);

        const processContent = () => {
          // Reset the innerHTML to its original state before processing
          const originalContent = songContent.innerHTML;
          songContent.innerHTML = originalContent.replace(chordRegex, '');

          // Find all text nodes that have content to process
          const nodesToProcess = [];
          const walker = document.createTreeWalker(songContent, NodeFilter.SHOW_TEXT, null, false);
          let node;
          while (node = walker.nextNode()) {
            if (node.nodeValue.trim().length > 0) {
              nodesToProcess.push(node);
            }
          }

          nodesToProcess.forEach(node => {
            const lines = node.nodeValue.split('\n');
            const newDiv = document.createElement('div');
            newDiv.classList.add('processed-content');

            lines.forEach(line => {
              const chordMatch = line.match(chordRegex);
              if (chordMatch) {
                const chordLine = document.createElement('div');
                chordLine.classList.add('chord-line');
                let currentChord = '';

                // Add chords
                for (let i = 0; i < line.length; i++) {
                  const char = line[i];
                  if (char === '[') {
                    const endIndex = line.indexOf(']', i);
                    if (endIndex > i) {
                      currentChord += line.substring(i + 1, endIndex);
                      i = endIndex;
                    }
                  } else {
                    currentChord += ' ';
                  }
                }
                chordLine.textContent = currentChord.trim();
                newDiv.appendChild(chordLine);
              }

              // Add lyric line
              const lyricLine = document.createElement('div');
              lyricLine.classList.add('lyric-line');
              lyricLine.textContent = line.replace(chordRegex, '');
              newDiv.appendChild(lyricLine);
            });

            node.parentNode.replaceChild(newDiv, node);
          });
        };

        if (hasChordsOnPage) {
          // If chords are found, make the toggle button visible and process content.
          chordToggleButton.style.display = 'block';
          processContent();
        } else {
          // If no chords are found, hide the toggle button.
          chordToggleButton.style.display = 'none';
        }

        // Add a click listener to the button to toggle the `show-chords` class.
        chordToggleButton.addEventListener('click', () => {
          body.classList.toggle('show-chords');
          if (body.classList.contains('show-chords')) {
            chordToggleButton.textContent = 'Hide Chords';
          } else {
            chordToggleButton.textContent = 'Show Chords';
          }
        });
      });
    </script>
    <!-- Script to register the service worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('{{ "/service-worker.js" | relative_url }}', { scope: '{{ "/" | relative_url }}' })
            .then(registration => {
              console.log('Service Worker registered: ', registration);
            })
            .catch(registrationError => {
              console.log('Service Worker registration failed: ', registrationError);
            });
        });
      }
    </script>
  </body>
</html>
