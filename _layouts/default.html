<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: 'en' }}">

  {%- include head.html -%}

  <body>

    {%- include header.html -%}

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <!-- New chord controls container -->
        <div id="chord-controls">
          <button id="chord-toggle-button">Show Chords</button>
        </div>
        
        <!-- The Jekyll content is now wrapped in a div for JavaScript access -->
        <div id="song-content">
          {{ content }}
        </div>
      </div>
    </main>

    {%- comment -%}
    {%- include footer.html -%}
    {%- include sub-footer.html -%}
    {%- endcomment -%}

    <!-- New JavaScript to process chords and handle the toggle -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const songContent = document.getElementById('song-content');
        const chordToggleButton = document.getElementById('chord-toggle-button');
        const body = document.body;
        
        // CSS to control the visual layout of the chords and lyrics.
        const style = document.createElement('style');
        style.textContent = `
          .chord-line, .lyric-line {
            display: block;
            white-space: pre;
            line-height: 1.2;
            font-family: monospace; /* Use a monospace font for consistent spacing */
          }
          .chord-line {
            font-weight: bold;
            color: #d12a2a; /* Make the chords stand out */
          }
          .processed-line {
            margin-bottom: 1em;
          }
          /* Hide chords by default */
          .chord-line {
            display: none;
          }
          /* This class is added to the body by the button click */
          body.show-chords .chord-line {
            display: block;
          }
        `;
        document.head.appendChild(style);

        // Regex to find chords and the text following them.
        const chordAndTextRegex = /(\[([^\]]+)\])([^\[]*)/g;
        // Regular expression to find both chords and directives to check for their existence.
        const chordproRegex = /(\[([^\]]+)\])|(\{([^\}]+)\})/g;

        // Check if the content has any chords or directives.
        const hasChordsOnPage = chordproRegex.test(songContent.innerHTML);

        // Function to process the content and reformat it for inline chords.
        const processContent = () => {
          const paragraphs = songContent.querySelectorAll('p');
          paragraphs.forEach(p => {
            const originalText = p.innerHTML;
            const lines = originalText.split(/\r?\n/);
            let newHtml = '';

            lines.forEach(line => {
              // Remove all {directive} from the line
              const cleanLine = line.replace(/\{[^}]+\}/g, '');
              if (/\[[^\]]+\]/.test(cleanLine)) {
                // Line has chords, process as before
                let result = '';
                let i = 0;
                while (i < cleanLine.length) {
                  if (cleanLine[i] === '[') {
                    const end = cleanLine.indexOf(']', i);
                    if (end !== -1) {
                      const chord = cleanLine.slice(i + 1, end);
                      const nextChar = cleanLine[end + 1];
                      if (nextChar && nextChar !== ' ') {
                        result += `<span class="chord-stack"><span class="chord">${chord}</span><span class="lyric-char">${nextChar}</span></span>`;
                        i = end + 2;
                      } else {
                        result += `<span class="chord-stack"><span class="chord">${chord}</span><span class="lyric-char"></span></span>`;
                        i = end + 1;
                      }
                      continue;
                    }
                  }
                  result += `<span class="lyric-char">${cleanLine[i]}</span>`;
                  i++;
                }
                newHtml += `<div class="processed-line"><span class="lyric-line">${result}</span></div>`;
              } else {
                // No chords: preserve original HTML (including italics, etc.), but remove directives
                if (cleanLine.trim() !== '') {
                  newHtml += `<div class="processed-line lyric-only-line">${cleanLine}</div>`;
                }
              }
            });

            p.innerHTML = newHtml;
          });
        };

        // --- Chord visibility persistence ---
        function setChordVisibility(show) {
          if (show) {
            document.body.classList.add('show-chords');
          } else {
            document.body.classList.remove('show-chords');
          }
        }

        // On every page load, set chord visibility from localStorage
        const showChords = localStorage.getItem('showChords') === 'true';
        setChordVisibility(showChords);

        // If the slider exists (on the home page), sync it and listen for changes
        const globalToggle = document.getElementById('global-chord-toggle');
        if (globalToggle) {
          globalToggle.checked = showChords;
          globalToggle.addEventListener('change', (e) => {
            localStorage.setItem('showChords', e.target.checked);
            setChordVisibility(e.target.checked);
          });
        }

        if (hasChordsOnPage) {
          // If chords are found, make the toggle button visible and process content.
          chordToggleButton.style.display = 'block';
          processContent();
        } else {
          // If no chords are found, hide the toggle button.
          chordToggleButton.style.display = 'none';
        }

        // Add a click listener to the button to toggle the `show-chords` class.
        chordToggleButton.addEventListener('click', () => {
          body.classList.toggle('show-chords');
          if (body.classList.contains('show-chords')) {
            chordToggleButton.textContent = 'Hide Chords';
          } else {
            chordToggleButton.textContent = 'Show Chords';
          }
        });
      });
    </script>
    <!-- Script to register the service worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
            .then(registration => {
              console.log('Service Worker registered: ', registration);
            })
            .catch(registrationError => {
              console.log('Service Worker registration failed: ', registrationError);
            });
        });
      }
    </script>
  </body>

</html>
